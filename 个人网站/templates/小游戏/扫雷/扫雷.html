<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰«é›·æ¸¸æˆ</title>
    <!-- å¼•å…¥ Socket.io åº“ï¼Œç”¨äºä¸åç«¯è¿›è¡Œ WebSocket é€šä¿¡ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        /* æ ·å¼ï¼šè®¾ç½®æ£‹ç›˜çš„å¸ƒå±€ï¼Œä½¿ç”¨ç½‘æ ¼å¸ƒå±€æ˜¾ç¤ºæ¯ä¸ªå•å…ƒæ ¼ */
        .board {
            display: grid;
            grid-template-columns: repeat(10, 40px);
            /* 10åˆ—ï¼Œæ¯åˆ—å®½åº¦ä¸º40px */
            grid-gap: 5px;
            /* å•å…ƒæ ¼ä¹‹é—´çš„é—´éš™ */
        }

        /* æ ·å¼ï¼šå•å…ƒæ ¼çš„åŸºæœ¬æ ·å¼ */
        .cell {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ccc;
            border: 1px solid #888;
            cursor: pointer;
            user-select: none;
        }

        /* æ ·å¼ï¼šå•å…ƒæ ¼è¢«æ­ç¤ºå */
        .cell.revealed {
            background-color: #ffffff;
        }

        /* æ ·å¼ï¼šæ ‡è®°ä¸ºæ——å¸œçš„å•å…ƒæ ¼ */
        .cell.flag {
            background-color: #f00;
        }

        /* æ ·å¼ï¼šè¸©åˆ°åœ°é›·çš„å•å…ƒæ ¼ */
        .cell.mined {
            background-color: red;
        }

        /* æ ·å¼ï¼šæ˜¾ç¤ºæ•°å­—çš„å•å…ƒæ ¼ */
        .cell.number {
            background-color: #ffffff;
        }

        /* æ ·å¼ï¼šæœªæ­ç¤ºçš„å•å…ƒæ ¼ */
        .cell.unrevealed {
            background-color: #8f8f8f;
        }
    </style>
</head>

<body>
    <h1>æ‰«é›·æ¸¸æˆ</h1>
    <!-- æ˜¾ç¤ºæ£‹ç›˜ -->
    <div class="board" id="board"></div>

    <script>
        // å»ºç«‹ä¸æœåŠ¡å™¨çš„ Socket.io è¿æ¥
        const socket = io('http://localhost:5001/gameæ‰«é›·');

        // åˆå§‹åŒ–æ£‹ç›˜æ•°æ®å’ŒçŠ¶æ€
        let board = [];
        let revealed = [];
        let flags = [];
        let game_over = false;
        let game_victory = false;

        // æ›´æ–°æ£‹ç›˜æ˜¾ç¤º
        function updateBoard(gameState) {
            // æ›´æ–°æ£‹ç›˜ã€å·²æ­ç¤ºå’Œæ——å¸œçŠ¶æ€
            board = gameState.board;
            revealed = gameState.revealed;
            flags = gameState.flags;

            // è·å–æ£‹ç›˜å…ƒç´ 
            const boardElement = document.getElementById('board');
            boardElement.innerHTML = ''; // æ¸…ç©ºå½“å‰æ£‹ç›˜

            // éå†æ£‹ç›˜çš„æ¯ä¸ªå•å…ƒæ ¼
            for (let row = 0; row < board.length; row++) {
                for (let col = 0; col < board[row].length; col++) {
                    // åˆ›å»ºä¸€ä¸ªå•å…ƒæ ¼
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.id = `cell-${row}-${col}`;

                    // æ ¹æ®å•å…ƒæ ¼çŠ¶æ€æ›´æ–°æ ·å¼
                    if (revealed[row][col]) {
                        // å¦‚æœå•å…ƒæ ¼å·²è¢«æ­ç¤º
                        cell.classList.add('revealed');
                        if (board[row][col] === -1) {
                            // åœ°é›·
                            cell.textContent = 'ğŸ’£';
                            cell.classList.add('mined');
                        } else if (board[row][col] > 0) {
                            // æ˜¾ç¤ºé‚»è¿‘åœ°é›·çš„æ•°å­—
                            cell.textContent = board[row][col];
                            cell.classList.add('number');
                        }
                    } else {
                        // æœªæ­ç¤ºçš„å•å…ƒæ ¼
                        cell.classList.add('unrevealed');
                    }

                    // æ ‡è®°æ——å¸œ
                    if (flags[row][col]) {
                        cell.classList.add('flag');
                        cell.textContent = 'ğŸš©';
                    }

                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ­ç¤ºå•å…ƒæ ¼
                    cell.addEventListener('click', () => {
                        if (!revealed[row][col] && !game_over) {
                            socket.emit('reveal_cell', { row, col });  // å‘é€æ­ç¤ºæ ¼å­çš„è¯·æ±‚
                        }
                    });

                    // æ·»åŠ åŒå‡»äº‹ä»¶ï¼Œæ­ç¤ºå…¨éƒ¨å•å…ƒæ ¼
                    cell.addEventListener('dblclick', () => {
                        if (revealed[row][col] && !game_over) {
                            socket.emit('reveal_all_cell', { row, col });  // å‘é€æ­ç¤ºæ ¼å­çš„è¯·æ±‚
                        }
                    });

                    // æ·»åŠ å³é”®ç‚¹å‡»äº‹ä»¶ï¼Œæ ‡è®°æˆ–å–æ¶ˆæ——å¸œ
                    cell.addEventListener('contextmenu', (event) => {
                        event.preventDefault(); // é˜»æ­¢é»˜è®¤çš„å³é”®èœå•
                        if (!revealed[row][col] && !game_over) {
                            socket.emit('flag_cell', { row, col });  // å‘é€æ ‡è®°æ——å¸œçš„è¯·æ±‚
                        }
                    });

                    // å°†å•å…ƒæ ¼æ·»åŠ åˆ°æ£‹ç›˜
                    boardElement.appendChild(cell);
                }
            }
        }

        // ç›‘å¬ä»æœåŠ¡å™¨æ¥æ”¶åˆ°çš„æ¸¸æˆçŠ¶æ€æ›´æ–°
        socket.on('game_state', (gameState) => {
            console.log('æ¥æ”¶åˆ°çš„æ¸¸æˆçŠ¶æ€:', gameState);
            updateBoard(gameState);  // æ›´æ–°æ£‹ç›˜æ˜¾ç¤º

            // æ¸¸æˆç»“æŸåˆ¤æ–­
            if (gameState.game_over) {
                game_over = true;
                alert('æ¸¸æˆç»“æŸï¼ä½ è¸©åˆ°åœ°é›·äº†ã€‚');
            }

            // æ¸¸æˆèƒœåˆ©åˆ¤æ–­
            if (gameState.game_victory && !game_victory) {
                game_victory = true;
                alert('æ¸¸æˆèƒœåˆ©');
            }
        });

        // ç›‘å¬è¿æ¥æˆåŠŸäº‹ä»¶
        socket.on('connect', () => {
            console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
        });
    </script>
</body>

</html>